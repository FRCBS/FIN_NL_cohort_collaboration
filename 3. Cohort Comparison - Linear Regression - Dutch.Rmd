---
title: "Ferritin model"
author: "Jan Karregat"
date: "18.11.2021"
output: pdf_document

--- 


# Summary


```{r setup, include=FALSE}
Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")

knitr::opts_chunk$set(
        echo = FALSE,
        message = FALSE,
        warning = FALSE
)

currentDate <- format(Sys.time(), "%Y-%m-%d")
FolderName <- paste("C:/Users/karre01j/OneDrive - Sanquin/A FORTE/A3 Collaboration Finland/1. Cohort Comparison Analysis/2. Analysis [R]/3. R Plots/", currentDate,sep="")
dir.create(FolderName)


library(lubridate)
library(plyr)
library(readr)
library(nFactors)
library(psych)
library(corrplot)
library(psych)
library(ggplot2)
library(ggthemes)
library(haven)
library(rsample)
library(broom)
library(scales)
library(kableExtra)
library(naniar)
library(haven)
library(foreign)
library(tableone)
library(stargazer)
library(gridExtra)
library(cowplot)
library(broom)
library(GGally)
library(ggfortify)
library(knitr)
library(lubridate)
library(car)
library(reshape2)
library(sfsmisc)
library(MASS)
library(ordinal)
library(sjmisc)
library(VIM)
library(epiDisplay)
library(epitools)
library(ez)
library(ggbeeswarm)
library(ggthemes)
library(rsample)
library(broom)
library(scales)
library(kableExtra)
library(boot)
library(readxl)
library(foreign)
library(corrr)
library(ggcorrplot)
library(tidyverse)
library(brms)
library(bayesplot)
library(tidylog, warn.conflicts = F)
```



# Data loading and preparation 
```{r}
all_cohorts <-  readRDS("C://Users//karre01j//OneDrive - Sanquin//A FORTE//A3 Collaboration Finland//1. Cohort Comparison Analysis//2. Analysis [R]//2. R Datasets//2. Cohort Comparison - Regression Data.rds")
```

# All cohorts together 

## Data
```{r}
# men
## menstruation and childbirth variables removed 
regression_data_men <- all_cohorts %>% 
  filter(Group == "Men") %>% 
  dplyr::select(ID, log_ferritin, Age, blood_volume, donation_count, log_last_donation, Cohort, iron_deficiency, Smoking, Group, Weight) %>%
  mutate(Age = scale(Age, scale = FALSE)[,1],
         donation_count = scale(donation_count, scale = FALSE)[,1],
         log_last_donation = scale(log_last_donation, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         donation_count_2 = donation_count^2) 

# premenopausal women
regression_data_pre <- all_cohorts %>% 
  filter(Group == "Women_Premenopausal") %>% 
  dplyr::select(ID, log_ferritin, Age, blood_volume, donation_count, log_last_donation, Cohort, iron_deficiency, Smoking, Group, Weight, Menstruation, PreviousChildbirth, Oral_contraception) %>%
  mutate(Age = scale(Age, scale = FALSE)[,1],
         donation_count = scale(donation_count, scale = FALSE)[,1],
         log_last_donation = scale(log_last_donation, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         donation_count_2 = donation_count^2) 

# postmenopausal womem 
## menstruation variable removed 
regression_data_post <- all_cohorts %>% 
  filter(Group == "Women_Postmenopausal") %>% 
  dplyr::select(ID, log_ferritin, Age, blood_volume, donation_count, log_last_donation, Cohort, iron_deficiency, Smoking, Group, Weight, Menstruation, PreviousChildbirth, Oral_contraception) %>%
  mutate(Age = scale(Age, scale = FALSE)[,1],
         donation_count = scale(donation_count, scale = FALSE)[,1],
         log_last_donation = scale(log_last_donation, scale = FALSE)[,1],
         blood_volume = scale(blood_volume, scale = FALSE)[,1],
         donation_count_2 = donation_count^2) 


```


# Model 1 [Crude Model]

## Model 1: Men

```{r men}
#men
#file <- "../results/bmodels/version3/linear_men_b"


linear_men_b <- brm(log_ferritin ~ 
                        #Age + 
                        #BMI + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, 
                      data = regression_data_men, 
                      #family = bernoulli(),
                      #file = file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_men_b)

```
# Model 1: Premenopausal

```{r  pre}
# premenopausal women
#file <- "../results/bmodels/version3/linear_pre_b"

linear_pre_b <- brm(log_ferritin ~ 
                        #Age + 
                        #BMI + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, # +
                        #Menstruation +
                        #PreviousChildbirth, 
                      data = regression_data_pre,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_pre_b)


```

# Model 1: Postmenopausal

```{r  post}
# postmenopausal women
#file <- "../results/bmodels/version3/linear_post_b"

linear_post_b <- brm(log_ferritin ~ 
                        #Age + 
                        #BMI + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, #+
                        #PreviousChildbirth,
                     data = regression_data_post, 
                     #family = bernoulli(),
                     #file=file, 
                     cores = 4,
                     iter= 10000
)

summary(linear_post_b)
```

## Diagnostics
### Trace
```{r , message=FALSE}
mcmc_plot(linear_men_b, type = "trace")
```

```{r , message=FALSE}
mcmc_plot(linear_pre_b, type = "trace")
```

```{r , message=FALSE}
mcmc_plot(linear_post_b, type = "trace")
```

Chains do not seem to get stuck.

### ACF bars
```{r}
mcmc_plot(linear_men_b, type = "acf_bar")
```


```{r}
mcmc_plot(linear_pre_b, type = "acf_bar")
```


```{r}
mcmc_plot(linear_post_b, type = "acf_bar")
```

Autocorrelation drops nicely.

### Rhat

```{r}
mcmc_plot(linear_men_b, type = "rhat")
```

```{r}
mcmc_plot(linear_pre_b, type = "rhat")
```

```{r}
mcmc_plot(linear_post_b, type = "rhat")
```
https://mc-stan.org/rstan/reference/Rhat.html


"The Rhat function produces R-hat convergence diagnostic, which compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (ie, the between- and within-chain estimates don't agree), R-hat is larger than 1. We recommend running at least four chains by default and only using the sample if R-hat is less than 1.05."

## Forest plots: Model 1


```{r , message=FALSE, warning=FALSE}
p <- mcmc_plot(linear_men_b, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

#p <- p + scale_x_log10()
#Ferritin needs to be removed
# plot.OR<-  tidy_logit_pre_menop_women %>%filter(!term=="log_Ferritin_beginning") %>%  dplyr::select(OR) %>% mutate(y=rev(2:(nrow(tidy_logit_pre_menop_women)))) %>% bind_rows(tibble(OR=NA,y=1 ))
# p <- p + geom_point(aes(y=y,x=OR),data=plot.OR, col="red")
p
```


```{r , message=FALSE, warning=FALSE}
p <- mcmc_plot(linear_pre_b, 
         type = "areas",
         prob=0.95,
         prob_est="median"
         #transformations = "exp"
        ) +
  geom_vline(xintercept = 0, color = "grey")

#p <- p + scale_x_log10()
p
```


```{r , message=FALSE, warning=FALSE}
p <- mcmc_plot(linear_post_b, 
         type = "areas",
         prob = 0.95,
         prob_est="median"
         #transformations = "exp"
         ) +
  geom_vline(xintercept = 0, color = "grey")

#p <- p + scale_x_log10()
#Ferritin needs to be removed
# plot.OR<-  tidy_logit_pre_menop_women %>%filter(!term=="log_Ferritin_beginning") %>%  dplyr::select(OR) %>% mutate(y=rev(2:(nrow(tidy_logit_pre_menop_women)))) %>% bind_rows(tibble(OR=NA,y=1 ))
# p <- p + geom_point(aes(y=y,x=OR),data=plot.OR, col="red")
p
```
# Ferritin by donation history [Donors]
```{r}
blood_data_summary_final <- all_cohorts %>% filter(Cohort == "DISIII")
blood_data_summary_final$Ferritin_thresh <- 15


plt_1 <-blood_data_summary_final %>%
  dplyr::select(Group, Ferritin, donation_count) %>% 
  ggplot(aes(x=donation_count, y=Ferritin)) +
  geom_hline(data = blood_data_summary_final, aes(yintercept = Ferritin_thresh), color = "dark red", size = .2) +
  geom_jitter(aes(color = Group), alpha = 0.25, width = 0.2, size = 0.2, height = 0, shape = 1) +
  geom_boxplot(aes(color = Group, group = donation_count), alpha = 0,
               width = 0.4,
               outlier.alpha = 0) +
  facet_grid(Group~.) +
  scale_color_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Women_Premenopausal", "Women_Postmenopausal","Men" )) +
  theme_bw() +
  theme(legend.position = "none", 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
       panel.border = element_rect(colour = NA),
        strip.background=element_blank(),
        strip.text = element_blank(),
        axis.line = element_line(colour="black"),
        axis.title.x = element_text(size = 8),
        axis.title.y =element_text(size = 8),
        axis.text = element_text(size = 8)) +
  scale_y_log10(breaks=c(5, 15,25,50,100)) +
  scale_x_continuous(breaks=c(0, 2, 4,6,8, 10)) +
  xlab("Nb of donations (2 years)") +
  ylab(expression("Ferritin ("*mu* "g/l)")) +
  geom_smooth(method = "lm") +
  geom_smooth()


plt_1

plt_2 <-blood_data_summary_final %>%
  dplyr::select(Group, Ferritin, last_donation) %>% 
 ggplot(aes(x=last_donation, y=Ferritin)) +
  geom_hline(data = blood_data_summary_final, aes(yintercept = Ferritin_thresh), color = "dark red", size = .2) +
  geom_point(aes(color = Group), alpha = 0.4,  size = 0.7, shape =1) +
  facet_grid(Group~., 
      labeller = label_wrap_gen(width = 2, multi_line = TRUE))  +
  scale_color_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Women_Premenopausal", "Women_Postmenopausal","Men" )) +
  theme_bw() +
  theme(legend.position = "none", 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = NA),
        strip.background=element_rect(colour="white",fill="white"),
        strip.text = element_text(face="bold", size = 10),
        axis.line = element_line(colour="black"),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 8)) +
  scale_y_log10(breaks=c(5, 15,25,50,100)) +
  scale_x_log10(breaks=c(60,90,180,360,1000)) +
  xlab("Days since last donation") +
  ylab("")+
  geom_smooth(method = "lm") +
  geom_smooth()

plt_2


Plots_DonationHistory <- cowplot::plot_grid(plt_1, plt_2,  ncol = 2, labels = c("A", "B"))

Plots_DonationHistory

FileName <- paste(FolderName, "/Donation History - Ferritin.png",sep="")
ggsave(FileName, width = 15, height = 10)


cowplot::save_plot("C:/Users/karre01j/OneDrive - Sanquin/A FORTE/A3 Collaboration Finland/1. Cohort Comparison Analysis/2. Analysis [R]/3. R Plots/ferritin_vs_donation_history.png",Plots_DonationHistory, base_height = NULL, base_aspect_ratio = .5, base_width = 11.5 * .394 ) 

```
# Ferritin by donation history [New/General population]
```{r}
blood_data_summary_final2 <- all_cohorts %>% filter(Cohort == "New Donors" | Cohort == "General Population")
blood_data_summary_final2$Ferritin_thresh <- 15

plt_1 <-blood_data_summary_final2 %>%
  dplyr::select(Group, Ferritin, donation_count) %>% 
  ggplot(aes(x=donation_count, y=Ferritin)) +
  geom_hline(data = blood_data_summary_final2, aes(yintercept = Ferritin_thresh), color = "dark red", size = .2) +
  geom_jitter(aes(color = Group), alpha = 0.25, width = 0.2, size = 0.2, height = 0, shape = 1) +
  geom_boxplot(aes(color = Group, group = donation_count), alpha = 0,
               width = 0.4,
               outlier.alpha = 0) +
  facet_grid(Group~.) +
  scale_color_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Women_Premenopausal", "Women_Postmenopausal","Men" )) +
  theme_bw() +
  theme(legend.position = "none", 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
       panel.border = element_rect(colour = NA),
        strip.background=element_blank(),
        strip.text = element_blank(),
        axis.line = element_line(colour="black"),
        axis.title.x = element_text(size = 8),
        axis.title.y =element_text(size = 8),
        axis.text = element_text(size = 8)) +
  scale_y_log10(breaks=c(5, 15,25,50,100)) +
  scale_x_continuous(breaks=c(0, 2, 4,6,8, 10)) +
  xlab("Nb of donations (2 years)") +
  ylab(expression("Ferritin ("*mu* "g/l)")) +
  geom_smooth(method = "lm") +
  geom_smooth()


plt_1

plt_2 <-blood_data_summary_final2 %>%
  dplyr::select(Group, Ferritin, last_donation) %>% 
 ggplot(aes(x=last_donation, y=Ferritin)) +
  geom_hline(data = blood_data_summary_final2, aes(yintercept = Ferritin_thresh), color = "dark red", size = .2) +
  geom_point(aes(color = Group), alpha = 0.4,  size = 0.7, shape =1) +
  facet_grid(Group~., 
      labeller = label_wrap_gen(width = 2, multi_line = TRUE))  +
  scale_color_manual(values = c( "#ff85a2",  "#de2d26","#00BFFF" ),
                     limits = c("Women_Premenopausal", "Women_Postmenopausal","Men" )) +
  theme_bw() +
  theme(legend.position = "none", 
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_rect(colour = NA),
        strip.background=element_rect(colour="white",fill="white"),
        strip.text = element_text(face="bold", size = 10),
        axis.line = element_line(colour="black"),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 8)) +
  scale_y_log10(breaks=c(5, 15,25,50,100)) +
  scale_x_log10(breaks=c(60,90,180,360,1000)) +
  xlab("Days since last donation") +
  ylab("")+
  geom_smooth(method = "lm") +
  geom_smooth()

plt_2


Plots_DonationHistory2 <- cowplot::plot_grid(plt_1, plt_2,  ncol = 2, labels = c("A", "B"))

Plots_DonationHistory2

FileName <- paste(FolderName, "/Donation History - Ferritin_2.png",sep="")
ggsave(FileName, width = 15, height = 10)


cowplot::save_plot("C:/Users/karre01j/OneDrive - Sanquin/A FORTE/A3 Collaboration Finland/1. Cohort Comparison Analysis/2. Analysis [R]/3. R Plots/ferritin_vs_donation_history_2.png",Plots_DonationHistory2, base_height = NULL, base_aspect_ratio = .5, base_width = 11.5 * .394 ) 

```

### All groups together
```{r}
regressor_values <- c(
 "Age" = "Age (5 years)",
   "log_CRP" = "CRP (log transformed)",
   "BMI" = "BMI",
   "log_last_donation" = "Days since last donation (log, /log(2))",
   "Smokingyes" ="Smoker",
    "iron_complience" = "Iron supplementation",
    "donation_count_2" = "Donations in last 2 years (quadratic)",
    "Menstruationregular_period" = "Regular periods",
    "Weight" = "Weight (10 kg)",
    "PreviousChildbirth" = "Given birth in the past",
    "donation_count" = "Donations in last 2 years"
 )
```



#  Model 1: Retrieve CI data
```{r }
# Group: Men
intervals_men <- mcmc_intervals_data(
  linear_men_b,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Men')
  
  intervals_men <- intervals_men %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Premenopausal women
intervals_pre <- mcmc_intervals_data(
  linear_pre_b,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Pre-menopausal women') %>% 
  arrange(m) # how to order the variables

  intervals_pre <- intervals_pre %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Postmenopausal women
intervals_post <- mcmc_intervals_data(
  linear_post_b,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Post-menopausal women')

  intervals_post <- intervals_post %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Combined
intervals_combined <- rbind(intervals_pre,intervals_post,intervals_men) %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) #%>% 
  #select(parameter)
  #arrange(m)


```


# Model 1: Forest plot - Men, Premonpausal women, Postmenopausal women
```{r , fig1, fig.height = 10, fig.width = 15 ,warning=FALSE}

orlower <- -1
orupper <- 1.5

# Truncate ORs for plotting
plotdata <- intervals_combined %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  )

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata$Group))/5 -0.1) 

p <- ggplot(plotdata, aes(x = m, y = regressor, color = Group)) + 
  geom_point(position = pos,
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 position = pos,
                 size = 1, 
                 linetype = 1
                 ) +
  scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                    limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  ylab("Coefficient") 

p

FileName <- paste(FolderName, "/Forest Plot - Ferritin - Linear Model 1 - Group.png",sep="")
ggsave(FileName, width = 10, height = 7)

```




# Model 2 [Corrected]

## Model 2: MEN

```{r men}
#men
linear_men_corrected <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, 
                      data = regression_data_men, 
                      #family = bernoulli(),
                      #file = file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_men_corrected)

```

```{r  pre}
# premenopausal women
#file <- "../results/bmodels/version3/linear_pre_b"

linear_pre_corrected <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, # +
                        #Menstruation +
                        #PreviousChildbirth, 
                      data = regression_data_pre,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_pre_corrected)


```

```{r  post}
# postmenopausal women
#file <- "../results/bmodels/version3/linear_post_b"

linear_post_corrected <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        #donation_count_2 + 
                        #donation_count +
                        #log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, #+
                        #PreviousChildbirth,
                     data = regression_data_post, 
                     #family = bernoulli(),
                     #file=file, 
                     cores = 4,
                     iter= 10000
)

summary(linear_post_corrected)
```

#  Model 2: Retrieve CI data
```{r }
# Group: Men
intervals_men_corrected <- mcmc_intervals_data(
  linear_men_corrected,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Men')

  intervals_men_corrected <- intervals_men_corrected %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))


# Group: Premenopausal women
intervals_pre_corrected <- mcmc_intervals_data(
  linear_pre_corrected,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Pre-menopausal women') %>% 
  arrange(m) # how to order the variables?

  intervals_pre_corrected <- intervals_pre_corrected %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Postmenopausal women
intervals_post_corrected <- mcmc_intervals_data(
  linear_post_corrected,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Post-menopausal women')

   intervals_post_corrected <- intervals_post_corrected %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Combined
intervals_combined_corrected <- rbind(intervals_pre_corrected,intervals_post_corrected,intervals_men_corrected) %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) #%>% 
  #select(parameter)
  #arrange(m)


```


# Men, Premonpausal women, Postmenopausal women
```{r , fig1, fig.height = 10, fig.width = 15 ,warning=FALSE}

orlower <- -1
orupper <- 1.5

# Truncate ORs for plotting
plotdata_combined_corrected <- intervals_combined_corrected %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  )

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata_combined_corrected$Group))/5 -0.1) 

p <- ggplot(plotdata_combined_corrected, aes(x = m, y = regressor, color = Group)) + 
  geom_point(position = pos,
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 position = pos,
                 size = 1, 
                 linetype = 1
                 ) +
  scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                    limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  ylab("Coefficient") 

p

FileName <- paste(FolderName, "/Forest Plot - Ferritin - Linear Model 2 - Group.png",sep="")
ggsave(FileName, width = 10, height = 7)

```



# Model 3 [Corrected + Donation history]

## Model 3: Men

```{r men}
#men
linear_men_corrected_donhist <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, 
                      data = regression_data_men, 
                      #family = bernoulli(),
                      #file = file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_men_corrected_donhist)

linear_men_corrected_donhist %>%
  add_residual_draws(m_ideal) %>%
  median_qi() %>%
  ggplot(aes(sample = .residual)) +
  geom_qq() +
  geom_qq_line()
```
## Model 3 [Corrected + Donation History]: Premenopausal Women

```{r  pre}
# premenopausal women
#file <- "../results/bmodels/version3/linear_pre_b"

linear_pre_corrected_donhist <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, # +
                        #Menstruation +
                        #PreviousChildbirth, 
                      data = regression_data_pre,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_pre_corrected_donhist)


```
## Model 3 [Corrected + Donation History]: Postmenopausal Women
```{r  post}
# postmenopausal women
#file <- "../results/bmodels/version3/linear_post_b"

linear_post_corrected_donhist <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        #Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, #+
                        #PreviousChildbirth,
                     data = regression_data_post, 
                     #family = bernoulli(),
                     #file=file, 
                     cores = 4,
                     iter= 10000
)

summary(linear_post_corrected_donhist)
```

#  Model 3: Retrieve CI data
```{r }
# Group: Men
intervals_men_corrected_donhist <- mcmc_intervals_data(
  linear_men_corrected_donhist,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Men')

  intervals_men_corrected_donhist <- intervals_men_corrected_donhist %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Premenopausal women
intervals_pre_corrected_donhist <- mcmc_intervals_data(
  linear_pre_corrected_donhist,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Pre-menopausal women') %>% 
  arrange(m) # how to order the variables?

  intervals_pre_corrected_donhist <- intervals_pre_corrected_donhist %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Postmenopausal women
intervals_post_corrected_donhist <- mcmc_intervals_data(
  linear_post_corrected_donhist,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Post-menopausal women')

  intervals_post_corrected_donhist <- intervals_post_corrected_donhist %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Combined
intervals_combined_corrected_donhist <- rbind(intervals_pre_corrected_donhist,intervals_post_corrected_donhist,intervals_men_corrected_donhist) %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) #%>% 
  #select(parameter)
  #arrange(m)


```
# Model 3: Forest Plot - Men, Premonpausal women, Postmenopausal women
```{r , fig1, fig.height = 10, fig.width = 15 ,warning=FALSE}

orlower <- -1
orupper <- 1.5

# Truncate ORs for plotting
plotdata_combined_corrected_donhist <- intervals_combined_corrected_donhist %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  )

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata_combined_corrected_donhist$Group))/5 -0.1) 

p <- ggplot(plotdata_combined_corrected_donhist, aes(x = m, y = regressor, color = Group)) + 
  geom_point(position = pos,
             size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh), 
                 position = pos,
                 size = 1, 
                 linetype = 1
                 ) +
  scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                    limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  ylab("Coefficient") 

p

FileName <- paste(FolderName, "/Forest Plot - Ferritin - Linear Model 3 - Group.png",sep="")
ggsave(FileName, width = 10, height = 7)

```




# Model 4 [Corrected + Donation History + Smoking/Menstruation/OCC use/Childbirth - Cohort NEW]

# Select data for model 4 (M4)
```{r}
regression_data_men_M4 <- regression_data_men %>%
  filter(! (Cohort == 'New Donors'))

regression_data_pre_M4 <- regression_data_pre %>%
  filter(! (Cohort == 'New Donors'))

regression_data_post_M4 <- regression_data_post %>%
  filter(! (Cohort == 'New Donors'))
```


# Model 4: Men
```{r  men}
# men

linear_men_M4 <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort, # +
                        #Menstruation +
                        #PreviousChildbirth, 
                      data = regression_data_men_M4,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_men_M4)


```


```{r  pre}
# premenopausal women

linear_pre_M4 <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort  +
                        PreviousChildbirth +
                        Menstruation +
                       Oral_contraception, 
                      data = regression_data_pre_M4,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_pre_M4)


```


```{r  post}
# postmenopausal women

linear_post_M4 <- brm(log_ferritin ~ 
                        Age + 
                        blood_volume + 
                        Smoking + 
                        #iron_complience + 
                        donation_count_2 + 
                        donation_count +
                        log_last_donation + 
                        #log_CRP +
                        #Region + 
                        #Weight +
                        #RedMeat_n +
                        Cohort +
                        Menstruation +
                        PreviousChildbirth+
                        Oral_contraception, 
                      data = regression_data_post_M4,
                      #family = bernoulli(),
                      #file=file, 
                      cores = 4,
                      iter= 10000
)

summary(linear_post_M4)


```




#  Model 4: Retrieve CI data
```{r }
# Group: Men
intervals_men_M4 <- mcmc_intervals_data(
  linear_men_M4,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Men')

  intervals_men_M4 <- intervals_men_M4 %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Premenopausal women
intervals_pre_M4 <- mcmc_intervals_data(
  linear_pre_M4,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Pre-menopausal women') 

  intervals_pre_M4 <- intervals_pre_M4 %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Postmenopausal women
intervals_post_M4 <- mcmc_intervals_data(
  linear_post_M4,
  prob=0.9,
  prob_outer = 0.95,
  point_est = "median"
  #transformations = "exp"
  ) %>% mutate(Group='Post-menopausal women')

  intervals_post_M4 <- intervals_post_M4 %>%
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma' | parameter == 'lprior')) %>% 
  mutate(parameter = gsub("b_","",parameter))

# Group: Combined
intervals_combined_M4 <- rbind(intervals_pre_M4,intervals_post_M4,intervals_men_M4) %>% 
  filter(! (parameter == 'b_Intercept' | parameter == 'lp__' | parameter == 'sigma')) %>% 
  mutate(parameter = gsub("b_","",parameter)) %>% 
  mutate(regressor = plyr::revalue(parameter, regressor_values)) #%>% 
  #select(parameter)
  #arrange(m)


```


# Model 4: Forest Plot - Men, Premonpausal women, Postmenopausal women
```{r}

orlower <- -1
orupper <- 1.5

# Truncate ORs for plotting
plotdata_combined_M4 <- intervals_combined_M4 %>% 
  mutate(
    ll = case_when(
      ll < orlower ~ orlower,
      TRUE ~ ll
    ),
    hh = case_when(
      hh > orupper ~ orupper,
      TRUE ~ hh
    )
  )

#theme_set(bayesplot::theme_default())
pos <- position_nudge(y=as.numeric(as.factor(plotdata_combined_M4$Group))/5 -0.1) 

p <- ggplot(plotdata_combined_M4, aes(x = m, y = parameter, color = Group)) + 
  geom_point(size = 4, position = position_dodge(width = -1)) +
  geom_linerange(aes(xmin = ll, 
                     xmax = hh),
                    size = 1, 
                    linetype = 1, 
                    position = position_dodge(width = -1))  +
  scale_color_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                     limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_fill_manual(values = c(  "#0065BD", "#BA0303", "#C50084" ),
                    limits = c("Men",  "Post-menopausal women","Pre-menopausal women" )) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower,orupper)  +   
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  ylab("Coefficient") 

p

FileName <- paste(FolderName, "/Forest Plot - Ferritin - Linear Model 4 - Group.png",sep="")
ggsave(FileName, width = 10, height = 7)

```






# Final Forest: MEN

```{r}
# Create final forest plot dataset
FinalForest_Model1_Men <- intervals_men
FinalForest_Model2_Men <- intervals_men_corrected
FinalForest_Model3_Men <- intervals_men_corrected_donhist
FinalForest_Model4_Men <- intervals_men_M4

FinalForest_Model1_Men <- FinalForest_Model1_Men[!(FinalForest_Model1_Men$parameter == "lprior"), ]
FinalForest_Model1_Men <- FinalForest_Model1_Men %>% 
  mutate(Model = "Model 1")

FinalForest_Model2_Men <- FinalForest_Model2_Men[!(FinalForest_Model2_Men$parameter == "lprior"), ]
FinalForest_Model2_Men <- FinalForest_Model2_Men %>% 
  mutate(Model = "Model 2")

FinalForest_Model3_Men <- FinalForest_Model3_Men[!(FinalForest_Model3_Men$parameter == "lprior"), ]
FinalForest_Model3_Men <- FinalForest_Model3_Men %>% 
  mutate(Model = "Model 3")

FinalForest_Model4_Men <- FinalForest_Model4_Men[!(FinalForest_Model4_Men$parameter == "lprior"), ]
FinalForest_Model4_Men <- FinalForest_Model4_Men %>% 
  mutate(Model = "Model 4")




# Combine datasets
FinalForest_ModelsCombined <- rbind(FinalForest_Model1_Men,FinalForest_Model2_Men,FinalForest_Model3_Men, FinalForest_Model4_Men)
FinalForest_ModelsCombined$Model <- as.factor(FinalForest_ModelsCombined$Model)
FinalForest_ModelsCombined$parameter <- gsub("CohortGeneralPopulation", "General Population", FinalForest_ModelsCombined$parameter)
FinalForest_ModelsCombined$parameter <- gsub("CohortNewDonors", "New Donors", FinalForest_ModelsCombined$parameter)
FinalForest_ModelsCombined$parameter <- gsub("blood_volume", "Blood_volume", FinalForest_ModelsCombined$parameter)
FinalForest_ModelsCombined$parameter <- gsub("SmokingYes", "Smoking", FinalForest_ModelsCombined$parameter)
FinalForest_ModelsCombined$parameter <- as.factor(FinalForest_ModelsCombined$parameter)




available_variables <- FinalForest_ModelsCombined %>%
  group_by(Model) %>%
  summarise(available_vars = paste(parameter, collapse = ", "))

desired_order <- c("New Donors", "General Population", "Age", "Blood_volume", "log_last_donation", "donation_count", "donation_count_2", "Smoking")
FinalForest_ModelsCombined$parameter <- factor(FinalForest_ModelsCombined$parameter, levels = rev(desired_order))

orlower_men <- -1
orupper_men <- 1

p <- ggplot(FinalForest_ModelsCombined, aes(x = m, y = parameter, color = parameter)) +
  geom_point(size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh),
                 size = 1,
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower_men,orupper_men)  +
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  labs(title = "Linear Models [Men]") +
  xlab("Coefficient") +
  ylab(" ") +
  facet_grid(Model ~ .)

p

FileName <- paste(FolderName, "/Forest Plot - Final - Men.png",sep="")
ggsave(FileName, width = 10, height = 7)


```

# Final Forest: PREMENOPAUSAL WOMEN

```{r}
# Create final forest plot dataset
FinalForest_Model1_Pre <- intervals_pre
FinalForest_Model2_Pre <- intervals_pre_corrected
FinalForest_Model3_Pre <- intervals_pre_corrected_donhist
FinalForest_Model4_Pre <- intervals_pre_M4

FinalForest_Model1_Pre <- FinalForest_Model1_Pre[!(FinalForest_Model1_Pre$parameter == "lprior"), ]
FinalForest_Model1_Pre <- FinalForest_Model1_Pre %>% 
  mutate(Model = "Model 1")

FinalForest_Model2_Pre <- FinalForest_Model2_Pre[!(FinalForest_Model2_Pre$parameter == "lprior"), ]
FinalForest_Model2_Pre <- FinalForest_Model2_Pre %>% 
  mutate(Model = "Model 2")

FinalForest_Model3_Pre <- FinalForest_Model3_Pre[!(FinalForest_Model3_Pre$parameter == "lprior"), ]
FinalForest_Model3_Pre <- FinalForest_Model3_Pre %>% 
  mutate(Model = "Model 3")

FinalForest_Model4_Pre <- FinalForest_Model4_Pre[!(FinalForest_Model4_Pre$parameter == "lprior"), ]
FinalForest_Model4_Pre <- FinalForest_Model4_Pre %>% 
  mutate(Model = "Model 4")



# Combine datasets
FinalForest_ModelsCombined_Pre <- rbind(FinalForest_Model1_Pre,FinalForest_Model2_Pre,FinalForest_Model3_Pre, FinalForest_Model4_Pre)
FinalForest_ModelsCombined_Pre$Model <- as.factor(FinalForest_ModelsCombined_Pre$Model)
FinalForest_ModelsCombined_Pre$parameter <- gsub("CohortGeneralPopulation", "General Population", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("CohortNewDonors", "New Donors", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("blood_volume", "Blood volume", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("SmokingYes", "Smoking", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("MenstruationYes", "Menstruation", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("PreviousChildbirthYes", "Childbirth", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- gsub("Oral_contraceptionYes", "Oral contraception", FinalForest_ModelsCombined_Pre$parameter)
FinalForest_ModelsCombined_Pre$parameter <- as.factor(FinalForest_ModelsCombined_Pre$parameter)



desired_order <- c("New Donors", "General Population", "Age", "Blood volume", "log_last_donation", "donation_count", "donation_count_2", "Smoking", "Childbirth", "Menstruation", "Oral contraception")

FinalForest_ModelsCombined_Pre$parameter <- factor(FinalForest_ModelsCombined_Pre$parameter, levels = rev(desired_order))

orlower_men <- -1
orupper_men <- 1

p <- ggplot(FinalForest_ModelsCombined_Pre, aes(x = m, y = parameter, color = parameter)) +
  geom_point(size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh),
                 size = 1,
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower_men,orupper_men)  +
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  labs(title = "Linear Models [Premenopausal Women]") +
  xlab("Coefficient") +
  ylab(" ") +
  facet_grid(Model ~ .)

p

FileName <- paste(FolderName, "/Forest Plot - Final - Premenopausal Women.png",sep="")
ggsave(FileName, width = 10, height = 7)


```



# Final Forest: POSTMENOPAUSAL WOMEN

```{r}
# Create final forest plot dataset
FinalForest_Model1_Post <- intervals_post
FinalForest_Model2_Post <- intervals_post_corrected
FinalForest_Model3_Post <- intervals_post_corrected_donhist
FinalForest_Model4_Post <- intervals_post_M4

FinalForest_Model1_Post <- FinalForest_Model1_Post[!(FinalForest_Model1_Post$parameter == "lprior"), ]
FinalForest_Model1_Post <- FinalForest_Model1_Post %>% 
  mutate(Model = "Model 1")

FinalForest_Model2_Post <- FinalForest_Model2_Post[!(FinalForest_Model2_Post$parameter == "lprior"), ]
FinalForest_Model2_Post <- FinalForest_Model2_Post %>% 
  mutate(Model = "Model 2")

FinalForest_Model3_Post <- FinalForest_Model3_Post[!(FinalForest_Model3_Post$parameter == "lprior"), ]
FinalForest_Model3_Post <- FinalForest_Model3_Post %>% 
  mutate(Model = "Model 3")

FinalForest_Model4_Post <- FinalForest_Model4_Post[!(FinalForest_Model4_Post$parameter == "lprior"), ]
FinalForest_Model4_Post <- FinalForest_Model4_Post %>% 
  mutate(Model = "Model 4")



# Combine datasets
FinalForest_ModelsCombined_Post <- rbind(FinalForest_Model1_Post,FinalForest_Model2_Post,FinalForest_Model3_Post, FinalForest_Model4_Post)
FinalForest_ModelsCombined_Post$Model <- as.factor(FinalForest_ModelsCombined_Post$Model)
FinalForest_ModelsCombined_Post$parameter <- gsub("CohortGeneralPopulation", "General Population", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("CohortNewDonors", "New Donors", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("blood_volume", "Blood volume", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("SmokingYes", "Smoking", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("MenstruationYes", "Menstruation", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("PreviousChildbirthYes", "Childbirth", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- gsub("Oral_contraceptionYes", "Oral contraception", FinalForest_ModelsCombined_Post$parameter)
FinalForest_ModelsCombined_Post$parameter <- as.factor(FinalForest_ModelsCombined_Post$parameter)



desired_order <- c("New Donors", "General Population", "Age", "Blood volume", "log_last_donation", "donation_count", "donation_count_2", "Smoking", "Childbirth",  "Oral contraception", "Menstruation")

FinalForest_ModelsCombined_Post$parameter <- factor(FinalForest_ModelsCombined_Post$parameter, levels = rev(desired_order))

orlower_men <- -1
orupper_men <- 1

p <- ggplot(FinalForest_ModelsCombined_Post, aes(x = m, y = parameter, color = parameter)) +
  geom_point(size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh),
                 size = 1,
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower_men,orupper_men)  +
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)
  ) +
  guides(shape = "none") +
  theme_classic() +
  labs(title = "Linear Models [Postmenopausal Women]") +
  xlab("Coefficient") +
  ylab(" ") +
  facet_grid(Model ~ .)

p

FileName <- paste(FolderName, "/Forest Plot - Final - Postmenopausal Women.png",sep="")
ggsave(FileName, width = 15, height = 10)


```



# Final forest all groups
```{r}
FinalForest_ModelsCombined_2 <- FinalForest_ModelsCombined
FinalForest_ModelsCombined_2$Group <- "Men"
FinalForest_ModelsCombined_Pre_2 <- FinalForest_ModelsCombined_Pre
FinalForest_ModelsCombined_Pre_2$Group <- "Women premenopausal"
FinalForest_ModelsCombined_Post_2 <- FinalForest_ModelsCombined_Post
FinalForest_ModelsCombined_Post_2$Group <- "Women postmenopausal"

FinalForest_ModelsCombined_All_2 <- rbind(FinalForest_ModelsCombined_2,FinalForest_ModelsCombined_Pre_2,FinalForest_ModelsCombined_Post_2)
FinalForest_ModelsCombined_All_2$Group <- factor(FinalForest_ModelsCombined_All_2$Group, levels = c("Men", "Women premenopausal", "Women postmenopausal"))
FinalForest_ModelsCombined_All_2$parameter <- gsub("Blood_volume", "Blood volume", FinalForest_ModelsCombined_All_2$parameter)


desired_order_parameter <- c("New Donors", "General Population", "Age", "Blood volume", "log_last_donation", "donation_count", "donation_count_2", "Smoking", "Childbirth", "Oral contraception", "Menstruation")
FinalForest_ModelsCombined_All_2$parameter <- factor(FinalForest_ModelsCombined_All_2$parameter, levels = rev(desired_order_parameter))


orlower_men <- -1
orupper_men <- 1.5

p <- ggplot(FinalForest_ModelsCombined_All_2, aes(x = m, y = parameter, color = parameter)) +
  geom_point(size=4) +
  geom_linerange(aes(xmin = ll, xmax = hh),
                 size = 1,
                 linetype = 1
                 ) +
  scale_shape_manual(values = c(1,16)) +
  xlim(orlower_men,orupper_men)  +
  geom_vline(xintercept = 0 , color = "grey", linetype = "dotted",
             size = 1) +
  theme_classic() +
  theme(axis.title = element_text(size = 14),
        strip.text =  element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.background = element_rect(fill = "white"),
        strip.background.x = element_blank(),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        panel.grid.major.y = element_line(color = "gray", linetype = "dotted"),
        panel.grid.major.x = element_blank(),
        legend.position = "none"
  ) +
  guides(shape = "none") +
  labs(title = "Linear Models") +
  xlab("Coefficient") +
  ylab(" ") +
  facet_grid(Model ~ Group,scale="free_y")

p

FileName <- paste(FolderName, "/Forest Plot - Final - All Groups.png",sep="")
ggsave(FileName, width = 15, height = 10)
```



# Save Linear Regression Summary Data Dataset

```{r}
saveRDS(FinalForest_ModelsCombined_All_2, file.path("C:/Users/karre01j/OneDrive - Sanquin/A FORTE/A3 Collaboration Finland/1. Cohort Comparison Analysis/2. Analysis [R]/2. R Datasets/", "5A. Cohort Comparison - Dutch Summary Data - Linear Regression.rds"))
```


